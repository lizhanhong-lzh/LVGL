# STM32F767 工业数据显示系统项目说明（交付版）

本文档面向交付验收与二次维护，覆盖项目结构、核心流程、协议规范、构建方式与运行要点。

---

## 1. 项目定位与目标

本项目运行在 STM32F767 开发板上，使用 LVGL 构建工业数据显示界面，通过 RS232 串口接收 SQMWD_Tablet 协议数据并解析显示。

核心目标：
- 稳定接收串口数据、解析协议、展示业务指标。
- 在低功耗与低负载前提下保持界面流畅。
- 支持数据丢包/异常情况下的容错与可观测性（调试面板）。

---

## 2. 目录结构与模块职责

```
LVGL1/
├─ User/                    # 业务与UI主逻辑
│  ├─ main.c                # 主入口、协议解析、调度
│  ├─ app/                   # 业务数据结构、环形缓冲、UI
│  │  ├─ app.h/.c            # 业务模型与模拟数据
│  │  ├─ obuf.h/.c           # 串口环形缓冲（SPSC）
│  │  └─ screens/            # LVGL界面绘制与刷新
│  └─ lv_port_*              # LVGL显示适配（触摸已禁用）
├─ Drivers/                 # 板级驱动（时钟、串口、LCD等）
├─ Middlewares/LVGL/         # LVGL库本体与配置
└─ Output/                   # 编译产物
```

说明：
- 核心逻辑在 User/main.c 与 User/app/ 下，Drivers 为硬件驱动层。
- Middlewares/LVGL 为第三方图形库，不建议随意改动。

---

## 3. 核心运行流程（总览）

1) 硬件初始化：时钟、串口、SDRAM、LCD、定时器。
2) LVGL 初始化：显示适配 + UI 创建。
3) 串口中断接收：每字节写入环形缓冲。
4) 主循环解析：从环形缓冲中解析 SQMWD_Tablet 帧。
5) 数据分发：更新业务结构体并刷新 UI（低频/差分刷新）。

---

## 4. 串口接收与缓存设计

### 4.1 环形缓冲（obuf）
- 采用 SPSC 模型：ISR 写入、主循环读取。
- 缓冲满时丢“新数据”，避免并发修改读指针引发竞态。
- 通过 dropped 计数监控丢包。

### 4.2 解析策略
- 主循环每次最多解析 N 帧，防止 UI 被饿死。
- 校验失败/长度异常时丢 1 字节继续找帧头。
- 长时间无新字节且仍有残留时清缓冲。

---

## 5. 协议规范（0x09）

### 5.1 帧格式

```
[0]  0x40        帧头1
[1]  0x46        帧头2
[2]  0x09        CMD
[3]  LEN         Payload长度
[4]  Sub_CMD     子命令
...  Payload     根据 Sub_CMD 定义
[N]  XOR_CHK     校验（XOR）
```

帧总长度 = 4（头+CMD+LEN） + payload_len + 1（校验）

### 5.2 Sub_CMD = 0x01（泵压帧）

```
Payload:
[0]     Sub_CMD = 0x01
[1..4]  float 泵压A (小端)
[5..8]  float 泵压B (小端)
```

### 5.3 Sub_CMD = 0x02（参数数值帧）

```
Payload:
[0]     Sub_CMD = 0x02
[1]     FID
[2..5]  float 数值 (小端)
[6..]   参数名字符串 (UTF-8，可为空)
```

### 5.4 Sub_CMD = 0x03（消息帧）

```
Payload:
[0]     Sub_CMD = 0x03
[1]     FID
[2..5]  float 自动关闭时间(秒, 小端)
[6..]   消息字符串 (UTF-8)
```

### 5.5 FID 字段定义（与 SQMWD_Tablet 一致）

| FID | 字段 | 说明 |
|---|---|---|
| 0x10 | 井斜 | Inclination |
| 0x11 | 方位 | Azimuth |
| 0x12 | 工具面 | Toolface |
| 0x13 | 重力工具面 | Gravity TF |
| 0x14 | 磁性工具面 | Magnetic TF |

说明：板端解析以 FID 为主，参数名字符串仅用于显示兜底。

---

## 6. UI 与数据刷新策略

### 6.1 关键显示
- 左侧：工具面同心圆弧（历史 5 条）。
- 右侧：井斜/方位/工具面/泵压/状态等实时数据。
- 底部：参数解码表（固定行数循环刷新，避免搬移开销）。

### 6.2 性能策略
- 主界面仅在数据变化时刷新。
- 解码表以“最近一条 + 时间戳”低频刷新。
- 调试面板低频刷新，减少刷屏开销。

### 6.3 小数显示策略
- 使用整数拼接显示小数，避免浮点 printf 被裁剪导致小数点丢失。

---

## 7. 构建与调试

### 7.1 Keil MDK
- 工程入口：LVGL1/Projects/MDK-ARM
- 适用场景：板端固件调试、烧录

### 7.2 CMake/PC 模拟器（如有）
- 适用场景：PC 端界面验证与协作调试

---

## 8. 常见问题与排查

1) 参数显示异常：确认发送为小端 float，非 ASCII。
2) 校验失败：核对 XOR 计算（从帧头到 payload 末尾）。
3) 界面卡顿：降低刷新频率或减少解码表刷写。

---

## 9. keilkill.bat 的用途

`keilkill.bat` 用于一键结束 Keil/编译相关进程，解决占用工程文件、无法重新编译或下载的问题。适合在 Keil 崩溃或烧录后锁文件时使用。

---

## 10. 交付说明

- 交付包含：固件工程、协议文档、测试帧与调试策略。
- 若需扩展字段，请先在 FID 表中定义，再在解析/显示处扩展。

---

## 作者与版本

- 硬件平台：正点原子 阿波罗 F767
- LVGL 移植：2026-01-23
- 协议对接：SQMWD_Tablet（0x09）
