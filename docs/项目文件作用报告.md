# 项目文件作用报告（工业看板 / LVGL + Lxb）

> 日期：2026-01-24  
> 目标：梳理工程结构与文件职责，说明 Lxb 数据来源与 LVGL UI 修改入口。

## 1. 总体结构概览

```
LVGL/                     主工程根目录
├─ LVGL1/                  STM32F767 板端工程（Keil MDK）
├─ Lxb/                    STM32L073 采集/转发工程（真实设备侧）
├─ src/                    PC 模拟主程序（SDL）
├─ third_party/            第三方库（PC 端）
├─ build/                  PC 端 CMake 构建输出
├─ config/                 PC 端 LVGL 配置
└─ docs/                   文档
```

## 2. Lxb 文件夹（真实设备侧）作用说明

> 结论：Lxb 是**采集/协议打包/转发**固件，不是显示端。

### 2.1 核心文件
- **[Lxb/main.c](../Lxb/main.c)**  
  主循环与协议发送核心：
  - TIM2 采样节拍
  - 采样数据组帧（CMD=0x00 / CMD=0x31）
  - LoRa 接收更新深度/钩载
  - USART1 / USART4 透传桥接

- **[Lxb/bsp.c](../Lxb/bsp.c)** / **[Lxb/bsp.h](../Lxb/bsp.h)**  
  板级支持包：定时器、GPIO、Flash/EEPROM、基础工具函数、环形缓冲 `__OBUF`。

### 2.2 采样相关
- **[Lxb/adc.c](../Lxb/adc.c)** / **[Lxb/adc.h](../Lxb/adc.h)**  
  TIM2 节拍与 ADS8354 外部 ADC 采样；内部 ADC1 轮询（basepress0/1）。

### 2.3 串口与 RS485
- **[Lxb/uart1.c](../Lxb/uart1.c)** / **[Lxb/uart1.h](../Lxb/uart1.h)**  
  USART1 收发，接收进 `__OBUF`，空闲中断置位。

- **[Lxb/uart485.c](../Lxb/uart485.c)** / **[Lxb/uart485.h](../Lxb/uart485.h)**  
  USART4 (RS485) 收发与方向控制，工程中与 USART1 做桥接透传。

### 2.4 LoRa
- **[Lxb/SX1278.c](../Lxb/SX1278.c)** / **[Lxb/SX1278.h](../Lxb/SX1278.h)**  
  LoRa 模块驱动，接收数据后更新 `jiaoche/gouzai` 等字段。

### 2.5 启动与工程文件
- **[Lxb/cstartup.s](../Lxb/cstartup.s)**  启动文件（向量表/堆栈/复位入口）。
- **[Lxb/stm32l073xx.h](../Lxb/stm32l073xx.h)**  芯片寄存器定义。
- **[Lxb/*.uvprojx](../Lxb/)**  Keil 工程文件。


## 3. LVGL1（F767 显示端）关键文件职责

### 3.1 入口与数据流
- **[LVGL1/User/main.c](../LVGL1/User/main.c)**  
  硬件初始化 → LVGL 初始化 → 解析 Lxb 协议 → 刷新 UI。

### 3.2 UI 与业务逻辑
- **[LVGL1/User/app/app.c](../LVGL1/User/app/app.c)**  
  应用入口与模拟数据定时器（无设备时显示用）。

- **[LVGL1/User/app/app.h](../LVGL1/User/app/app.h)**  
  业务数据结构 `plant_metrics_t`（深度/钩载/波形）。

- **[LVGL1/User/app/screens/dashboard.c](../LVGL1/User/app/screens/dashboard.c)**  
  工业界面布局与刷新逻辑（你现在的界面就在这里）。

- **[LVGL1/User/app/screens/dashboard.h](../LVGL1/User/app/screens/dashboard.h)**  
  界面头文件。

### 3.3 协议与缓存
- **[LVGL1/User/app/obuf.c](../LVGL1/User/app/obuf.c)** / **[LVGL1/User/app/obuf.h](../LVGL1/User/app/obuf.h)**  
  串口字节环形缓冲。

- **[LVGL1/User/app/proto_lxb.c](../LVGL1/User/app/proto_lxb.c)** / **[LVGL1/User/app/proto_lxb.h](../LVGL1/User/app/proto_lxb.h)**  
  Lxb 协议解析与校验。

### 3.4 LVGL 显示与触摸移植
- **[LVGL1/Middlewares/LVGL/GUI/lvgl/examples/porting/lv_port_disp_template.c](../LVGL1/Middlewares/LVGL/GUI/lvgl/examples/porting/lv_port_disp_template.c)**  
  显示刷屏回调与 LCD 驱动对接。

- **[LVGL1/User/lv_port_indev_template.c](../LVGL1/User/lv_port_indev_template.c)**  
  触摸输入对接（不需要触摸可关闭）。


## 4. 我应该修改哪些文件来改 LVGL 界面？

**只改 UI：**
- [LVGL1/User/app/screens/dashboard.c](../LVGL1/User/app/screens/dashboard.c)
- [LVGL1/User/app/screens/dashboard.h](../LVGL1/User/app/screens/dashboard.h)

**改数据结构与显示字段：**
- [LVGL1/User/app/app.h](../LVGL1/User/app/app.h)
- [LVGL1/User/main.c](../LVGL1/User/main.c)（协议字段映射）


## 5. 建议的开发流程

1) 在 VSCode 中修改 UI 代码（dashboard.c/h）。  
2) 如有 PC 模拟器，先运行验证布局与交互。  
3) 使用 Keil MDK5 编译并下载到板端验证真实显示、触摸与串口。  

原因：UI 调整频繁，先模拟可减少下载次数；最终必须板端验证外设与性能。


## 6. 后续可选优化
- 若 Lxb 使用 CMD=0x31 大包，需要扩展缓冲与分片重组机制。  
- 若深度/钩载有固定单位比例，可在 UI 侧格式化成工程单位（如 m / t）。
